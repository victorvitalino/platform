= javascript_include_tag "//www.google.com/jsapi", "chartkick"

:css
  .table {
    font-size: 14px !important;
  }

  .table th, td {
    padding: 6 !important;
    vertical-align: baseline !important;
  }

.container
  .row.box
    .col-md-12
      .box_internal
        .col-md-12
          .row
            .col-md-12
              %h1
                %b Detalhamento do Candidato
              %h4
                = link_to "Ir para listas", url_for('/pagina/43')
                |
                = link_to "Pesquisar CPF", find_candidate_path
          %hr/
          .row
            .col-md-12
              %h3
                %b Situação do candidato
          .row
            .col-md-12
              %table#data-table-command.table.table-striped.table-vmiddle.datatable
                %thead
                  %tr
                    %th Situação do Candidato
                    %th Programa
                    %th Faixa
                    %th Lista
                    %th Posição
                    %th Última pontuação
                %tbody
                  - if @candidate.list.present?
                    - @candidate.list.each do |list|
                      %tr
                        %td
                          %span.label.label-success
                            = @candidate.current_situation_name
                        %td= program(@candidate.program_id)
                        %td= list[1][0]
                        %td= translate_list(list[0])
                        %td= "#{list[2]}º"
                        %td= @candidate.pontuations.last.total if @candidate.pontuations.present?

                  - else
                    %tr
                      %td= @candidate.current_situation_name
                      %td= program(@candidate.program_id)
                      %td
                      %td
                      %td
                      %td= @candidate.pontuations.last.total if @candidate.pontuations.present?
          %hr/
          .row
            .col-md-12
              %h3
                %b Histórico de situação
          .row
            .col-md-12
              - if @candidate.list.present?
                %table#data-table-command.table.table-striped.table-vmiddle.datatable
                  %thead
                    %tr
                      %th Situação
                      %th Data da situação
                  %tbody
                    - @candidate.cadastre_situations.order('id ASC').each do |candidate|
                      %tr
                        %td= candidate.situation_status.name.upcase if candidate.situation_status.present?
                        %td= candidate.created_at.strftime('%d/%m/%Y')
              - else
                Informação não disponível
          %hr/
          .row
            .col-md-12
              %h3
                %b Indicado ao empreendimento
          .row
            .col-md-12
              - if @candidate.enterprise_cadastres.present?
                %table#data-table-command.table.table-striped.table-vmiddle.datatable
                  %thead
                    %tr
                      %th Empreendimento
                      %th Data de encaminhamento
                  %tbody
                    - @candidate.enterprise_cadastres.each do |enterprise|
                      %tr
                        %td= enterprise.enterprise.name if enterprise.enterprise.present?
                        %td= enterprise.created_at.strftime("%d/%m/%Y")
              - else
                Informação não disponível
          %hr/
          .row
            .col-md-12
              %h3
                %b Dados Pessoais
          .row
            .col-md-12
              %table#data-table-command.table.table-striped.table-vmiddle.datatable
                %thead
                  %tr
                    %th{colspan: 3} Nome Completo
                    %th CPF
                    %th Sexo
                    %th Estado Civil
                %tbody
                  %tr
                    %td{colspan: 3}= @candidate.name
                    %td= @candidate.cpf
                    %td= @candidate.gender
                    %td= @candidate.civil_state.name if @candidate.civil_state.present?
                %thead
                  %tr
                    %th Chegada ao DF
                    %th Naturalidade
                    %th Condição Especial
                    %th CID
                    %th NIS
                %tbody
                  %tr
                    %td.col-md-2= @candidate.arrival_df.strftime('%d/%m/%Y') if @candidate.arrival_df.present?
                    %td.col-md-2= "#{@candidate.place_birth} #{@candidate.born_uf}"
                    %td.col-md-2= @candidate.special_condition.name if @candidate.special_condition.present?
                    %td.col-md-2= @candidate.cid
                    %td.col-md-2= @candidate.nis.present? ? "Possui NIS" : "Não possui NIS"

          %hr/
          .row
            .col-md-12
              %h3
                %b Pontuações
              = link_to "Como funciona a pontuação?"
          %hr/
          .row
            .col-md-12{style: 'text-align: center'}
              %h4
                %i Linha temporal de Pontuação
              = area_chart @candidate.pontuations.map {|key| [Date.parse(key.code.to_s).strftime('%Y-%m-%d'), key.total]}
            .col-md-12{style: 'text-align: center'}
              %hr/
              %h4
                %i Detalhamento
              %table.table.table-vmiddle.datatable
                %thead
                  %tr
                    %th Data
                    %th Posição
                    %th Renda Familiar
                    %th Tempo de Brasília
                    %th Dependentes
                    %th Condição Especial
                    %th Tempo de Lista
                    %th Total
                %tbody
                  - @candidate.pontuations.order('code DESC').each_with_index do |pontuation, index|
                    %tr{style: 'background-color: #F1F1F1'}
                      %td
                        %h4
                          %span.label.label-success
                            %b= pontuation.year.strftime('%d/%m/%Y')
                      %td
                        %b= "#{pontuation.position} º"
                      - @last_point = pontuation.position
                      %td= pontuation.income
                      %td.col-md-2= pontuation.bsb
                      %td.col-md-2= pontuation.dependent
                      %td.col-md-2= pontuation.special_condition
                      %td.col-md-2= pontuation.timelist
                      %td= pontuation.total
                    - if pontuation.cadastre_mirror.present?
                      %tr.pontuation{id: "id#{pontuation.id}"}
                        %td{colspan: 2}
                          %h5= link_to "Critérios #{pontuation.year.strftime('%Y')}", portal.page_path(48)
                        %td
                          %h5= number_to_currency pontuation.cadastre_mirror.income
                        %td
                          %h5= "#{pontuation.cadastre_mirror.arrival_df_time(pontuation.year)} Ano(s)"
                        %td{style: 'padding-top: 13px'}
                          - pontuation.cadastre_mirror.dependent_mirrors.each do |dependent|
                            %span{title: "#{dependent.special?}"}
                              - if dependent.special_condition_id != 1
                                .label.label-primary{style: 'margin: 1px'}
                                  %i{class: 'fa fa-wheelchair'}
                              - else
                                - if dependent.masculino?
                                  .label.label-success{style: 'margin: 1px'}
                                    %i{class: 'fa fa-male'}
                                - if dependent.feminino?
                                  .label.label-pink{style: 'margin: 1px'}
                                    %i{class: 'fa fa-female'}
                        %td
                          %h6= pontuation.cadastre_mirror.special_condition.name if pontuation.cadastre_mirror.special_condition.present?
                        %td
                          %h6= "#{pontuation.cadastre_mirror.timelist_time(pontuation.year)} Ano(s)"
                      %tr
                        %td{colspan: 7, style: 'background-color: white'}

          %hr/
          .row
            .col-md-12
              %h2
                %b Atendimentos & Agendamentos
          .row
            .col-md-12
              %table#data-table-command.table.table-striped.table-vmiddle.datatable
                %thead
                  %tr
                    %th Status
                    %th Convocação
                    %th Observação
                    %th Data
                %tbody
                  - @candidate.attendances.order(:created_at).each do |attendance|
                    - unless attendance.attendance_status_id == 99
                      %tr
                        %td= (attendance.attendance_status.present?) ? attendance.attendance_status.name  : 'Informação não disponível'
                        %td= (attendance.convocation.present?) ? attendance.convocation.description  : 'Informação não disponível'
                        %td= (attendance.observation.present?) ? attendance.observation : 'Informação não disponível'
                        %td= attendance.created_at.strftime('%d/%m/%Y às %H:%M')
          %hr/
          .row
            .col-md-12
              %h2
                %b Informações da Construtora
          .row
            .col-md-12
              - if @candidate.firm_enterprise_statuses.present?
                %table#data-table-command.table.table-striped.table-vmiddle.datatable
                  %thead
                    %tr
                      %th Empresa
                      %th Status
                      %th Observação
                      %th Data
                  %tbody
                    - @candidate.firm_enterprise_statuses.order(:created_at).each do |firm|
                      %tr
                        %td= firm.enterprise_cadastre.enterprise.name if firm.enterprise_cadastre.present? && firm.enterprise_cadastre.enterprise.present?
                        %td= firm.status_cadastre.name if firm.status_cadastre.present?
                        %td= (firm.observation.to_s.empty?) ? 'Não informado' : firm.observation
                        %td= firm.created_at.strftime('%d/%m/%Y às %H:%M')
              - else
                Informação não disponível
          .row
        .row
